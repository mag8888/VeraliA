"""
–ú–æ–¥—É–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Instagram –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –ø–æ–º–æ—â—å—é GPT
"""
import os
import logging
from typing import Dict, Any, Optional
from openai import OpenAI
import json

logger = logging.getLogger(__name__)


class GPTAnalyzer:
    """–ö–ª–∞—Å—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Instagram –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –ø–æ–º–æ—â—å—é GPT"""
    
    def __init__(self):
        api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            logger.warning("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. GPT –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
            self.client = None
        else:
            self.client = OpenAI(api_key=api_key)
        
        self.model = os.getenv("OPENAI_MODEL", "gpt-4o-mini")  # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å gpt-4o-mini –∏–ª–∏ gpt-4
    
    def generate_report(self, profile_data: Dict[str, Any], screenshot_data: Dict[str, Any]) -> Dict[str, str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —Å –ø–æ–º–æ—â—å—é GPT
        
        Args:
            profile_data: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            screenshot_data: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
            
        Returns:
            dict: {"ru": "–æ—Ç—á–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º", "en": ""}
        """
        if not self.client:
            logger.error("GPT –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ OPENAI_API_KEY.")
            return {"ru": "", "en": ""}
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
        prompt = self._build_prompt(profile_data, screenshot_data)
        
        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
            response_ru = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {
                        "role": "system",
                        "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É Instagram –∞–∫–∫–∞—É–Ω—Ç–æ–≤, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ –≤–ª–∏—è–Ω–∏—è –∏ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞—Ö —Å –±—Ä–µ–Ω–¥–∞–º–∏. –ì–µ–Ω–µ—Ä–∏—Ä—É–π –¥–µ—Ç–∞–ª—å–Ω—ã–µ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –¥–ª—è —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π –∏ –±—Ä–µ–Ω–¥–æ–≤. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                temperature=0.7,
                max_tokens=4000
            )
            
            report_ru = response_ru.choices[0].message.content.strip()
            
            logger.info("GPT –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
            return {
                "ru": report_ru,
                "en": ""
            }
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ GPT –æ—Ç—á–µ—Ç–∞: {e}")
            return {"ru": "", "en": ""}
    
    def _build_prompt(self, profile_data: Dict[str, Any], screenshot_data: Dict[str, Any]) -> str:
        """
        –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è GPT –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
        
        Args:
            profile_data: –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            screenshot_data: –î–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
            
        Returns:
            str: –ü—Ä–æ–º–ø—Ç –¥–ª—è GPT
        """
        followers = profile_data.get('followers', 0)
        posts_count = profile_data.get('posts_count', 0)
        bio = profile_data.get('bio', 'Not specified')
        views = screenshot_data.get('views', 0)
        interactions = screenshot_data.get('interactions', 0)
        new_followers = screenshot_data.get('new_followers', 0)
        messages = screenshot_data.get('messages', 0)
        shares = screenshot_data.get('shares', 0)
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
        followers_text = f"{followers:,}" if followers > 0 else "(–Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ ~100‚Äì200K, —É—Ç–æ—á–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)"
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π Instagram –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:

–î–ê–ù–ù–´–ï –ü–†–û–§–ò–õ–Ø:
‚Äì –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: {followers_text}
‚Äì –ü—É–±–ª–∏–∫–∞—Ü–∏–∏: {posts_count if posts_count > 0 else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
‚Äì –ë–∏–æ–≥—Ä–∞—Ñ–∏—è: {bio if bio else "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
‚Äì –ü—Ä–æ—Å–º–æ—Ç—Ä—ã (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π): {views:,} {f"({views/1000000:.1f} –º–ª–Ω)" if views >= 1000000 else ""}
‚Äì –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π): {interactions:,} {f"({interactions/1000000:.1f} –º–ª–Ω)" if interactions >= 1000000 else ""}
‚Äì –ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π): {new_followers:,}
‚Äì –°–æ–æ–±—â–µ–Ω–∏–π: {messages:,}
‚Äì –ö–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–º –ø–æ–¥–µ–ª–∏–ª–∏—Å—å: {shares:,}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç—á–µ—Ç –°–¢–†–û–ì–û –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ):

1. OVERALL ACCOUNT METRICS & PERFORMANCE

–ù–∞—á–Ω–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ "Followers:" –∏ —É–∫–∞–∂–∏ {followers_text if followers > 0 else "(–Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ ~100‚Äì200K, —É—Ç–æ—á–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)"}

–ó–∞—Ç–µ–º –æ–ø–∏—à–∏:
- Posts: {posts_count if posts_count > 0 else "unknown"}
- Views (last 30 days): {views:,} - –¥–∞–π –æ—Ü–µ–Ω–∫—É –≤–∏—Ä—É—Å–Ω–æ—Å—Ç–∏
- Interactions (last 30 days): {interactions:,} - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
- New followers (last 30 days): {new_followers:,} - –æ—Ü–µ–Ω–∏ —Ä–æ—Å—Ç
- Shares (content shared): {shares:,} - –æ–±—ä—è—Å–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —à–µ—Ä–∏–Ω–≥–æ–≤

–í—ã—á–∏—Å–ª–∏ Engagement Rate (ER) –º–µ—Å—è—á–Ω—ã–π:
ER ‚âà {interactions:,} / (–æ—Ü–µ–Ω–∫–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤) √ó 100

–î–∞–π –≤—ã–≤–æ–¥ –æ —Ñ–∞–∑–µ —Ä–æ—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞.

2. AUDIENCE & CONTENT ANALYSIS

–û–ø—Ä–µ–¥–µ–ª–∏:
- –ù–∏—à—É (Niche)
- –°—Ç–∏–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (Content Style)
- –î–µ–º–æ–≥—Ä–∞—Ñ–∏—é –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (Audience Demographics)
- –£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (Audience Trust Level)
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö (Emotional Tone in Comments)

3. POTENTIAL PARTNERS & ADVERTISERS

–†–∞–∑–±–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
1. –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏ –∫–æ—É—á–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å—ã
2. –õ–∞–π—Ñ—Å—Ç–∞–π–ª –∏ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –±—Ä–µ–Ω–¥—ã
3. –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —Å–µ–≥–º–µ–Ω—Ç –∑–Ω–∞–∫–æ–º—Å—Ç–≤
4. –ü—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—è
5. –ö–æ–Ω—Ç–µ–Ω—Ç-–∫—Ä–µ–∞—Ç–æ—Ä—ã –∏ –∫—Ä–æ—Å—Å-–ø—Ä–æ–º–æ

4. COMPLIMENTS ‚Äî STRONG POINTS OF THE ACCOUNT

–í—ã–¥–µ–ª–∏ 5 —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω –∞–∫–∫–∞—É–Ω—Ç–∞ —Å —ç–º–æ–¥–∑–∏ üåü

5. SPECIFIC RECOMMENDATIONS FOR IMPROVEMENT

–î–∞–π 5-6 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:
1. –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Highlights
2. –í–≤–µ—Å—Ç–∏ —Ñ–æ—Ä–º–∞—Ç "—Å–µ—Ä–∏–π–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"
3. –£—Å–∏–ª–∏—Ç—å CTAs –≤ Reels
4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—É—Å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –≤ –≥–ª—É–±–æ–∫—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é
5. –ù–∞—á–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

6. ADDITIONAL INSIGHTS

–í–∫–ª—é—á–∏:
- üî• –õ—É—á—à–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- üìà –£—Å–∫–æ—Ä–∏—Ç–µ–ª–∏ —Ä–æ—Å—Ç–∞
- üí∞ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫. –°–æ—Ö—Ä–∞–Ω—è–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏."""
        
        return prompt

